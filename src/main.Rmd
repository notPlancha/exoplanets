---
title: "R Notebook"
output: html_notebook
---

```{r}
library(here)
library(tidyverse)
library(conflicted)
# library(easystats)

exoplanets <- read_csv(here("data", "exoplanet_catalog_080325.csv"))
exoplanets
```


```{r}
library(skimr)
skim(exoplanets)
```


```{r,fig.asp=2}
library(naniar)
gg_miss_var(exoplanets)
```


```{r, fig.width=20, fig.height=10}
library(visdat)
vis_dat(exoplanets)
```


```{r}
names(exoplanets)
```


```{r}
library(janitor)
exoplanets %>% tabyl(planet_status)
```


```{r}
library(data.table)
# options(repr.matrix.max.rows=100)
exoplanets %>% 
  add_prop_miss() %>%
  arrange(prop_miss_all) %>% 
  head(5) %>% 
  data.table::transpose(keep.names="column") -> preview

preview
# preview %>% View()
```

We have a lot of features:
- Planet name
- Mass (M jup)
- Mass*sin(i) (M jup)
  - This describes minimum mass of the planet due to inclination effect
- Radius (Rjup)
- Period (day)
- a / the average distance of the planet and its star
  - it's in AU (astronomical units), which is the standard distance used for these types of things
  - 1 AU is the average distance tween the earth and the sun
- e / eccentry of a planet (between 0 and 1)
  - represenets how much of a circle is the orbit
  - e = 0 means perfect circle, e > 1 means its not bound to the star
- Discovery - year when it was discovered
- update - year it was updated
- 

```{r}
conflicts_prefer(dplyr::filter)
exoplanets %>% 
  filter(name %>% str_like("%TOI-784%"))
```


```{r}
conflicts_prefer(dplyr::filter)
exoplanets %>% 
  filter(discovered == 2023)
```

```{r}
exoplanets %>%
  mutate(
    ra_rad = ra,  # Convert RA to radians
    dec_rad = dec  # Convert Dec to radians
  ) %>% 
  ggplot(aes(x = ra_rad, y = dec_rad, color = dec)) +
  geom_point(size = 0.4) +
  coord_map("aitoff") +  # Apply Aitoff projection
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"  # Optionally remove legend
  )
```


```{r}
# check columsn that start with star
exoplanets %>% 
  select(starts_with("star"))
```


```{r}
library(dplyr)
library(plotly)
conflicts_prefer(plotly::layout)
# Create a new column to distinguish Kepler exoplanets
exoplanets_3d <- exoplanets %>%
  mutate(
    ra_rad = ra * pi / 180,   # Convert RA from degrees to radians
    dec_rad = dec * pi / 180, # Convert Dec from degrees to radians
    x = cos(dec_rad) * cos(ra_rad), # Convert to Cartesian coordinates
    y = cos(dec_rad) * sin(ra_rad),
    z = sin(dec_rad),
    color = case_when(  # Create a column for red when kepler, blue otherwise
      str_detect(paste(name, alternate_names), regex("kepler|koi", ignore_case = TRUE)) ~ "Kepler",
      # if it's free floating (star_name is NA)
      star_name %>% is.na() ~ "Free Floating",
      TRUE ~ "Other"
    ),
    hover_text = paste("Name: ", name) # Create custom hover text with the name of the exoplanet
  )

# Define steps for opacity slider
steps <- list(
  list(args = list("marker.opacity", 0.0), label = "0.0", method = "restyle"),
  list(args = list("marker.opacity", 0.1), label = "0.1", method = "restyle"),
  list(args = list("marker.opacity", 0.2), label = "0.2", method = "restyle"),
  list(args = list("marker.opacity", 0.3), label = "0.3", method = "restyle"),
  list(args = list("marker.opacity", 0.4), label = "0.4", method = "restyle"),
  list(args = list("marker.opacity", 0.5), label = "0.5", method = "restyle"),
  list(args = list("marker.opacity", 0.6), label = "0.6", method = "restyle"),
  list(args = list("marker.opacity", 0.7), label = "0.7", method = "restyle"),
  list(args = list("marker.opacity", 0.8), label = "0.8", method = "restyle"),
  list(args = list("marker.opacity", 0.9), label = "0.9", method = "restyle"),
  list(args = list("marker.opacity", 1.0), label = "1.0", method = "restyle")
)

# Create an interactive 3D scatter plot with plotly
plot_ly(
  data = exoplanets_3d,
  x = ~x,
  y = ~y,
  z = ~z,
  color = ~color,  # Use the kepler_highlight column for color mapping
  colors = c("Other" = "red", "Kepler" = "blue", "Free Floating" = "green"),
  text = ~hover_text, # Show the name of the exoplanet on hover
  type = "scatter3d",
  mode = "markers",
  marker = list(size = 1, opacity = 0.7), # Default opacity
  showlegend = TRUE
) %>%
  layout(
    title = "3D Sky Map of Exoplanets (Kepler Highlighted)",
    scene = list(
      xaxis = list(title = "X"),
      yaxis = list(title = "Y"),
      zaxis = list(title = "Z")
    ),
    sliders = list(
      list(
        active = 1,  # Set the default opacity value to 1.0 (fully opaque)
        currentvalue = list(
          prefix = "Opacity: ",
          font = list(size = 15)
        ),
        pad = list(t = 60),
        steps = steps  # Use the steps defined earlier for the opacity slider
      )
    )
  )

```

```{r}

# Assuming your data is loaded as 'exoplanets'
# Convert RA to degrees (if it's in hours:minutes:seconds format)
# If RA is already in degrees, skip this step
exoplanets %>%
  mutate(
    ra_deg = ra,  # Convert RA from hours to degrees (if needed)
    # Convert to polar coordinates for plotting
    # RA is mapped to theta (0-360 degrees)
    theta = ra_deg
  ) %>% 
ggplot(aes(x = theta, y = star_distance, color = mass)) +
  # Use coord_polar for circular plot
  coord_polar(start = 0, direction = -1) + # Start at 0 degrees, clockwise direction
  # Add concentric circles for distance reference
  geom_hline(yintercept = c(10, 100, 1000, 10000), 
             color = "gray", linetype = "solid", size = 0.3, alpha = 0.7) +
  # Add radial lines for angle reference
  geom_vline(xintercept = seq(0, 330, by = 30), 
             color = "gray", linetype = "solid", size = 0.3, alpha = 0.7) +
  # Plot the exoplanets
  geom_point(alpha = 0.8, size = 1) +
  # Use log scale for distance
  scale_y_log10(
    breaks = c(10, 100, 1000, 10000),
    labels = c("10 pc", "100 pc", "1000 pc", "10000 pc"),
    limits = c(1, 15000)
  ) +
  # Use log scale for mass colors
  scale_color_gradientn(
    colors = c("#1E90FF", "#32CD32", "#FFFF00", "#FFA500", "#FF4500", "#FF0000"),
    trans = "log10",
    breaks = c(0.0001, 0.001, 0.01, 0.1, 1, 10),
    labels = c("10⁻⁴", "10⁻³", "10⁻²", "10⁻¹", "10⁰", "10¹"),
    name = "Planetary Mass (MJup)"
  ) +
  # Remove grid and axis elements
  theme_minimal() +
  theme(
    axis.title = element_blank(),
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    panel.grid = element_blank(),
    legend.position = "bottom",
    legend.box = "horizontal",
    plot.title = element_text(hjust = 0.5)
  ) +
  ggtitle("Exoplanet Distribution")
```


```{r}
library(dplyr)
library(plotly)

# Create a new column to distinguish Kepler exoplanets
exoplanets_3d <- exoplanets %>%
  mutate(
    ra_rad = ra * pi / 180,   # Convert RA from degrees to radians
    dec_rad = dec * pi / 180, # Convert Dec from degrees to radians
    x = cos(dec_rad) * cos(ra_rad), # Convert to Cartesian coordinates
    y = cos(dec_rad) * sin(ra_rad),
    z = sin(dec_rad),
    color = case_when(  # Create a column for red when kepler, blue otherwise
      str_detect(paste(name, alternate_names), regex("kepler|koi", ignore_case = TRUE)) ~ "Kepler",
      # if it's free floating (star_name is NA)
      star_name %>% is.na() ~ "Free Floating",
      TRUE ~ "Other"
    ),
    hover_text = paste("Name: ", name), # Create custom hover text with the name of the exoplanet
    scaled_x = x * (1 / star_distance),  # Adjust x coordinate by star distance (closer = closer to center)
    scaled_y = y * (1 / star_distance),  # Adjust y coordinate similarly
    scaled_z = z * (1 / star_distance)   # Adjust z coordinate similarly
  )

# Define steps for opacity slider
steps <- list(
  list(args = list("marker.opacity", 0.0), label = "0.0", method = "restyle"),
  list(args = list("marker.opacity", 0.1), label = "0.1", method = "restyle"),
  list(args = list("marker.opacity", 0.2), label = "0.2", method = "restyle"),
  list(args = list("marker.opacity", 0.3), label = "0.3", method = "restyle"),
  list(args = list("marker.opacity", 0.4), label = "0.4", method = "restyle"),
  list(args = list("marker.opacity", 0.5), label = "0.5", method = "restyle"),
  list(args = list("marker.opacity", 0.6), label = "0.6", method = "restyle"),
  list(args = list("marker.opacity", 0.7), label = "0.7", method = "restyle"),
  list(args = list("marker.opacity", 0.8), label = "0.8", method = "restyle"),
  list(args = list("marker.opacity", 0.9), label = "0.9", method = "restyle"),
  list(args = list("marker.opacity", 1.0), label = "1.0", method = "restyle")
)

# Create an interactive 3D scatter plot with plotly
fig <- plot_ly(
  data = exoplanets_3d,
  x = ~scaled_x,
  y = ~scaled_y,
  z = ~scaled_z,
  color = ~color,  # Use the kepler_highlight column for color mapping
  colors = c("Other" = "red", "Kepler" = "blue", "Free Floating" = "green"),
  text = ~hover_text, # Show the name of the exoplanet on hover
  type = "scatter3d",
  mode = "markers",
  marker = list(size = 2, opacity = 0.7), # Default opacity
  showlegend = TRUE
)

# Add layout with a slider for opacity
fig <- fig %>% layout(
  title = "3D Sky Map of Exoplanets (Kepler Highlighted)",
  scene = list(
    xaxis = list(title = "X"),
    yaxis = list(title = "Y"),
    zaxis = list(title = "Z")
  ),
  sliders = list(
    list(
      active = 1,  # Set the default opacity value to 1.0 (fully opaque)
      currentvalue = list(
        prefix = "Opacity: ",
        font = list(size = 15)
      ),
      pad = list(t = 60),
      steps = steps  # Use the steps defined earlier for the opacity slider
    )
  )
)

fig


```



```{r}
exoplanets %>% names()
```

```{r}
# check how many are missing
exoplanets %>% 
  select(ra, dec, angular_distance) %>% 
  mutate(ra = ra %>% is.na(), dec = dec %>% is.na(), angular_distance = angular_distance %>% is.na()) %>%
  summarise_all(mean) %>%
  gather(key="column", value="percentage")
```


```{r}
# check which ones dont have ra
exoplanets %>% 
  filter(ra %>% is.na())
```

```{r}
# check out alternate names
exoplanets %>% 
  select(name, alternate_names) %>% 
  filter(alternate_names %>% str_length() > 0)

```

```{r}
exoplanets %>% 
  tabyl(publication)
```


```{r}
# remove any column with error in the name
exoplanets_r <- exoplanets %>% 
  select(-contains("error")) %>% 
  select(-planet_status, -updated, -alternate_names, -publication) %>% # useless
  select(-hot_point_lon, ) # too many missings
exoplanets_r %>% names
```

```{r, fig.width=20, fig.height=10}
library(visdat)
vis_dat(exoplanets_r)
```

```{r, fig.width=20, fig.height=10}
vis_miss(exoplanets_r, sort_miss = T, cluster = T)
```


# detection type
```{r}
exoplanets %>% 
  tabyl("detection_type") %>% 
  arrange(-n)
```

```{r}
library(fastDummies)
exoplanets_rd <- exoplanets_r %>% 
  dummy_cols(select_columns = "detection_type", split = ", ") %>% 
  # make them bools
  mutate_at(vars(starts_with("detection_type_")), as.logical)
exoplanets_rd %>% select(starts_with("detection_type")) %>% 
  unique
```

```{r, fig.width=10, fig.height=20}
library(naniar)
exoplanets_rd %>%
  group_by(`detection_type_Primary Transit`) %>% 
  miss_var_summary() %>% 
  arrange(variable) %>% 
  filter(variable %>% str_detect("detection_type", negate = T)) %>% 
  ggplot(aes(x = variable, y = pct_miss, fill = `detection_type_Primary Transit`)) +
  geom_col(position="dodge") +
  coord_flip() 
```


## Kepler

```{r}
# filter by the kepler
exoplanets %>% 
  filter(name %>% str_like("%Kepler%")) %>% 
  tabyl("detection_type")
```

```{r}
# check other
exoplanets %>% 
  filter(detection_type == "Other")
```


```{r}

```

